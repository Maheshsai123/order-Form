<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client Order Form</title>
  <style>
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #ece9e6, #ffffff);
      margin: 0;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0px 4px 15px rgba(0,0,0,0.1);
      max-width: 1100px;
      margin: auto;
    }
    h2 {
      text-align: center;
      color: #222;
      margin-bottom: 20px;
    }
    .form-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
    }
    .form-header input, .form-header select {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      flex: 1;
    }
    .styled-table {
      width: 100%;
      border-collapse: collapse;
    }
    .styled-table th, .styled-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    .styled-table th {
      background: #007bff;
      color: white;
    }
    .form-actions {
      text-align: center;
      margin-top: 20px;
    }
    button {
      background: #007bff;
      color: white;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      margin: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #0056b3;
      transform: scale(1.05);
    }
    .delete-btn {
      background: #dc3545;
    }
    .delete-btn:hover {
      background: #a71d2a;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Client Order Form</h2>

    <form id="orderForm" method="POST" enctype="multipart/form-data">
      <div class="form-header">
        <input type="text" name="doc_no" id="doc_no" value="{{ doc_no }}" readonly>
        <select name="vendor" id="vendor" required>
          <option value="">-- Select Vendor --</option>
          {% for v in vendors %}
          <option value="{{ v }}">{{ v }}</option>
          {% endfor %}
        </select>
        <input type="date" name="date" id="date" value="{{ today }}" readonly>
      </div>

      <table class="styled-table" id="orderTable">
        <thead>
          <tr>
            <th>S.No</th>
            <th>Item</th>
            <th>Design</th>
            <th>Size</th>
            <th>Qty</th>
            <th>Image</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="form-actions">
        <button type="button" onclick="addRow()">+ Add Row</button>
        <button type="button" onclick="saveOrder()">Save Order</button>
      </div>
    </form>
  </div>

  <script>
    function addRow() {
      const table = document.getElementById("orderTable").getElementsByTagName('tbody')[0];
      const rowCount = table.rows.length;
      const row = table.insertRow(rowCount);

      row.innerHTML = `
        <td>${rowCount + 1}</td>
        <td>
          <select>
            <option value="">Select Item</option>
            <option value="Shirt">Shirt</option>
            <option value="Pant">Pant</option>
            <option value="T-Shirt">T-Shirt</option>
            <option value="Kurta">Kurta</option>
          </select>
        </td>
        <td>
          <select>
            <option value="">Select Design</option>
            <option value="Plain">Plain</option>
            <option value="Striped">Striped</option>
            <option value="Checked">Checked</option>
            <option value="Printed">Printed</option>
          </select>
        </td>
        <td>
          <label><input type="checkbox" value="S" onclick="updateQty(this)"> S</label>
          <label><input type="checkbox" value="M" onclick="updateQty(this)"> M</label>
          <label><input type="checkbox" value="L" onclick="updateQty(this)"> L</label>
          <label><input type="checkbox" value="XL" onclick="updateQty(this)"> XL</label>
          <label><input type="checkbox" value="XXL" onclick="updateQty(this)"> XXL</label>
        </td>
        <td><input type="number" value="0" readonly></td>
        <td><input type="file" accept="image/*"></td>
        <td><button type="button" class="delete-btn" onclick="deleteRow(this)">-</button></td>
      `;
    }

    function deleteRow(btn) {
      const row = btn.closest("tr");
      row.remove();
    }

    function updateQty(checkbox) {
      const row = checkbox.closest("tr");
      const qtyInput = row.querySelector("td:nth-child(5) input");
      const checked = row.querySelectorAll("td:nth-child(4) input:checked").length;
      qtyInput.value = checked;
    }

    function saveOrder() {
      const form = document.getElementById("orderForm");
      const rows = document.querySelectorAll("#orderTable tbody tr");
      const orderData = [];

      rows.forEach((row, index) => {
        const item = row.cells[1].querySelector("select").value;
        const design = row.cells[2].querySelector("select").value;
        const sizes = Array.from(row.cells[3].querySelectorAll("input:checked")).map(c => c.value).join(",");
        const qty = row.cells[4].querySelector("input").value;
        const image = row.cells[5].querySelector("input").files[0];

        orderData.push([index + 1, item, design, sizes, qty, image]);
      });

      const formData = new FormData(form);
      formData.append("order_json", JSON.stringify(orderData.map((row, i) => {
        if (row[5]) formData.append(`image_${i}`, row[5]);
        return [row[0], row[1], row[2], row[3], row[4], row[5] ? `image_${i}` : ""];
      })));

      fetch("/", {
        method: "POST",
        body: formData
      })
      .then(res => res.text())
      .then(() => {
        alert("✅ Order saved!");
        window.location.reload();
      })
      .catch(err => {
        console.error(err);
        alert("❌ Failed to save order.");
      });
    }
  </script>
</body>
</html>
